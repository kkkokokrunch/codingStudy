## HTTP2

http有两个缺点：安全性不足和性能不高。

安全性不足这一缺点已经通过https改进了，所以http2主要改进了他性能不高这一缺点。

http2主要有以下几个方面的改进：

1. 二进制分帧
2. 多路复用
3. 头部压缩
4. 服务器推送

### 二进制分帧

原来的明文传输变成了二进制传输，原本的报文消息被划分成了更小的数据帧，帧就是数据传输的最小单位。

它把 TCP 协议的部分特性挪到了应用层，把原来的“Header+Body”的消息“打散”为数个小片的二进制“帧”（Frame），用“HEADERS”帧存放头数据、“DATA”帧存放实体数据。

#### 二进制帧双向传输序列

同一个消息往返的帧会分配唯一一个的流ID，这些数据帧按次序组装起来就是请求报文和响应报文

从`流`的层面看，`消息`就是有序的`帧`组成的序列，而在连接的层面上看，消息却是乱序收发的帧。

#### 帧的结构

Frame Header

第一行是帧的长度

第二行是帧的类型（数据帧和控制帧）和标志位

第三行是流的标识符，也就是帧所属的“流”，接收方使用它就可以从乱序的帧里识别出具有相同流 ID 的帧序列，按顺序组装起来就实现了虚拟的“流”。

Frame Payload

里面放的是实际传输的数据

虽然帧是乱序发送的 ，但是在这个流里，帧是有序的，而且有着严格的先后顺序。

### 流的特点

1. 流是可并发的，一个 HTTP/2 连接上可以同时发出多个流传输数据，也就是并发多请求，实现“多路复用”；
2. 客户端和服务器都可以创建流，双方互不干扰；流是双向的，一个流里面客户端和服务器都可以发送或接收数据帧，也就是一个“请求 - 应答”来回；
3. 流之间没有固定关系，彼此独立，但流内部的帧是有严格顺序的；
4. 流可以设置优先级，让服务器优先处理，比如先传 HTML/CSS，后传图片，优化用户体验；
5. 流 ID 不能重用，只能顺序递增，客户端发起的 ID 是奇数，服务器端发起的 ID 是偶数；
6. 在流上发送“RST_STREAM”帧可以随时终止流，取消接收或发送；第 0 号流比较特殊，不能关闭，也不能发送数据帧，只能发送控制帧，用于流量控制。

### 头部压缩

报文header经常会携带很多的头部字段，但body却可能只有几十字节，所以http2把**头部压缩**作为一个改进的重点。

不过 HTTP/2 并没有使用传统的压缩算法，而是开发了专门的**“HPACK”**算法，在客户端和服务器两端建立“字典”，用索引号表示重复的字符串，还釆用哈夫曼编码来压缩整数和字符串，可以达到 50%~90% 的高压缩率。





### 多路复用

http2在一个TCP连接上用“流”同时发送多个碎片化消息，就是多路复用——多个往返通信都用一个链接来处理。

在“流”的层面上看，消息是一些有序的“帧”序列，而在“连接”的层面上看，消息却是乱序收发的“帧”。多个请求 / 响应之间没有了顺序关系，不需要排队等待，也就不会再出现“队头阻塞”问题，降低了延迟，大幅度提高了连接的利用率。

http1长连接：若干个请求排队，一个请求的结果返回了，下一个请求才发送，一旦有请求超时，后面的就会被阻塞，这就是队头阻塞
http2多路复用：多个请求并行，一个请求耗时严重不影响其他请求。

 http/1里的请求都是排队处理的，所以有队头阻塞。

http/2的请求是乱序的，彼此不依赖，所以没有队头阻塞。

### 服务器推送

服务器不再完全被动的响应请求，也可以新建“流”主动向客户端发送消息，比如浏览器刚请求HTML的时候，就提前把可能会用到的CSS和JS发给客户端

